<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
   <title>Chore Chart Â· COSMOS</title>

  <!-- PWA bits -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1026">

  <!-- iOS-specific â€œinstallable web appâ€ flags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Chore Chart">
  <link rel="apple-touch-icon" href="./icons/180.png">

  <style>
    /* COSMOS THEME ... */

    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@500;700;800&display=swap');

    :root{
      --bg1: #070716;          /* deep space */
      --bg2: #0b1026;          /* midnight blue */
      --card: rgba(19, 22, 46, .85);
      --ink: #e8f0ff;
      --muted: #9aa7c7;
      --good: #27f0a7;         /* nebula green */
      --bad: #ff3b7f;          /* magenta flare */
      --edge: rgba(255,255,255,.08);
      --halo: rgba(123, 255, 247, .45); /* cyan halo */
      --halo2: rgba(178, 102, 255, .45); /* purple halo */
      --grid: rgba(120, 172, 255, .06);
      --warn: #ffd166;         /* amber */
    }

    html, body { height: 100%; }
    html { background-color: #070716; } /* solid fallback under the status bar */
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
      user-select: none; overscroll-behavior: none;

      /* layered stars + aurora gradient */
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(123,255,247,.12), transparent 60%),
        radial-gradient(900px 700px at 85% 20%, rgba(178,102,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));

  padding-top: env(safe-area-inset-top);
    }

    /* starfield */
    body::before, body::after{
      content:"";
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:
        radial-gradient(2px 2px at 12% 18%, rgba(255,255,255,.8) 50%, transparent 55%),
        radial-gradient(1.5px 1.5px at 48% 12%, rgba(255,255,255,.7) 50%, transparent 55%),
        radial-gradient(1.2px 1.2px at 78% 28%, rgba(255,255,255,.6) 50%, transparent 55%),
        radial-gradient(2px 2px at 22% 66%, rgba(255,255,255,.85) 50%, transparent 55%),
        radial-gradient(1.4px 1.4px at 66% 72%, rgba(255,255,255,.7) 50%, transparent 55%),
        radial-gradient(1px 1px at 90% 40%, rgba(255,255,255,.6) 50%, transparent 55%);
      opacity:.5;
    }
    body::after{
      filter: blur(0.2px);
      opacity:.35;
      transform: translateZ(0);
    }

    .wrap{ max-width: 1100px; margin: 0 auto; padding: 28px 20px 40px; position: relative; z-index: 1; }
    header{ display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom: 16px; }
    .title{
      font-family: 'Orbitron', sans-serif;
      font-weight:700;
      letter-spacing: 1px;
      font-size: clamp(34px, 4vw, 56px);
      line-height: 1;
      text-transform: uppercase;
      background: linear-gradient(90deg, #b366ff, #7bfff7, #b366ff);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      filter: drop-shadow(0 0 10px rgba(123,255,247,.15));
    }
    .subtitle{
      color: var(--muted);
      font-size: clamp(13px, 2vw, 15px);
      font-weight: 700;
      letter-spacing:.3px;
      margin-top: 6px;
    }

    header::after{
      content:"";
      display:block;
      position: absolute;
      left:50%;
      transform: translateX(-50%);
      width: min(1000px, 92%);
      height: 2px;
      background:
        linear-gradient(90deg, transparent, rgba(123,255,247,.5) 15%, rgba(179,102,255,.5) 85%, transparent);
      margin-top: 64px;
      box-shadow: 0 0 18px rgba(123,255,247,.25);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      justify-items: center;
      margin-top: 22px;
    }

    .bottom-row {
      grid-column: 1 / span 3;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      justify-content: center;
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(18,20,48,.9), rgba(12,16,36,.8));
      border: 1px solid var(--edge);
      border-radius: 16px;
      padding:18px;
      position:relative; isolation:isolate;
      width: 100%;
      max-width: 300px;
      min-height: 190px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.04) inset,
        0 10px 24px rgba(0,0,0,.45);
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      overflow: clip;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: 16px;
      padding:1px;
      background: linear-gradient(135deg, var(--halo), var(--halo2));
      -webkit-mask: 
        linear-gradient(#000 0 0) content-box, 
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      opacity:.55;
      pointer-events:none;
    }
    .card:hover{ transform: translateY(-2px); }

    .card.todo-glow{
      box-shadow:
        0 0 22px rgba(255,59,127,.25),
        0 10px 24px rgba(0,0,0,.5);
      border-color: rgba(255,59,127,.35);
    }
    .card.pending-glow{
      box-shadow:
        0 0 22px rgba(255,209,102,.25),
        0 10px 24px rgba(0,0,0,.5);
      border-color: rgba(255,209,102,.35);
    }
    .card.done-glow{
      box-shadow:
        0 0 22px rgba(39,240,167,.25),
        0 10px 24px rgba(0,0,0,.5);
      border-color: rgba(39,240,167,.35);
    }

    .kid{ display:flex; align-items:center; gap:10px; margin-bottom:12px; }

    .avatar{
      width:42px; height:42px; border-radius:50%;
      display:grid; place-items:center;
      font-weight:800; color:#0c1024;
      background:
        radial-gradient(circle at 30% 30%, #7bfff7, #b366ff 65%, #4a1a8f 90%);
      border: 2px solid rgba(255,255,255,.55);
      box-shadow:
        inset 0 2px 10px rgba(0,0,0,.35),
        0 0 12px rgba(123,255,247,.35);
      position: relative;
      font-family: 'Orbitron', sans-serif;
    }
    .avatar::after{
      content:"";
      position:absolute; inset:-6px;
      border-radius: 50%;
      border: 1px solid rgba(123,255,247,.35);
      transform: rotate(20deg);
      filter: blur(.3px);
      pointer-events:none;
    }

    .kid h3{
      margin:0;
      font-size:18px;
      letter-spacing:.3px;
      font-weight:800;
      font-family: 'Inter', sans-serif;
    }

    .status{
      margin-left:auto;
      font-weight:800; font-size: 12px; letter-spacing:.4px;
      padding:6px 10px; border-radius: 999px;
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      backdrop-filter: blur(3px);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
      text-transform: uppercase;
    }
    .dot{ width:10px; height:10px; border-radius:50%; }
    .status.good{ color: var(--good); }
    .status.bad{ color: var(--bad); }
    .status.warn{ color: var(--warn); }

    .chore{
      margin-top: 6px;
      font-size: clamp(20px, 2.3vw, 24px);
      color: var(--ink);
      font-weight:800;
      text-align:center;
      letter-spacing:.3px;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
    }

    .btns{ display:flex; gap:10px; margin-top:auto; }

    button.big{
      position: relative;
      flex:1; padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      color: var(--ink);
      font-size:13px; font-weight:800; letter-spacing:.4px;
      text-transform: uppercase;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        0 6px 14px rgba(0,0,0,.45);
      transition: transform .1s ease, background .15s ease, box-shadow .15s ease, border-color .15s ease;
      backdrop-filter: blur(3px);
      display:flex; align-items:center; justify-content:center; gap:6px;
    }
    button.big:active{ transform: translateY(1px); }

    .btn-request{
      border-color: rgba(255,209,102,.45);
      background: linear-gradient(180deg, rgba(255,209,102,.18), rgba(255,209,102,.08));
      color:#fff3d6;
      text-shadow: 0 0 8px rgba(255,209,102,.45);
    }
    .btn-confirm{
      border-color: rgba(39,240,167,.45);
      background: linear-gradient(180deg, rgba(39,240,167,.18), rgba(39,240,167,.08));
      color:#caffec;
      text-shadow: 0 0 8px rgba(39,240,167,.45);
    }
    .btn-disabled{
      opacity:.5; cursor:not-allowed;
    }

    .just-done{ animation: bounce .4s ease; }

    @keyframes bounce {
      0%   { transform: scale(1); }
      30%  { transform: scale(1.06); }
      50%  { transform: scale(0.97); }
      70%  { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    footer{
      margin-top: 18px;
      display:flex; flex-direction:column; gap:10px;
      color: var(--muted); font-size: 13px; font-weight:700;
      border-top: 1px solid rgba(255,255,255,.1);
      padding-top: 14px;
    }

    .foot-top{
      display:flex; justify-content:space-between; align-items:center;
      gap: 12px;
    }

    .kbd{
      font-family: 'Inter', monospace;
      background: rgba(255,255,255,.06);
      padding:4px 8px; border-radius:8px;
      border:1px solid rgba(255,255,255,.18);
      color:#cfe2ff; font-weight:800;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing:.5px;
    }

    /* === Weekly Progress Bar (NEW) === */
    .weekly-wrap{
      display:flex; flex-direction:column; gap:8px;
    }
    .weekly-label{
      display:flex; justify-content:space-between; align-items:center;
      font-weight:800; color:#cfe2ff;
    }
    .progress-outer{
      width:100%; height:14px; border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.2), 0 0 0 1px rgba(255,255,255,.04);
      overflow:hidden;
    }
    .progress-inner{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(39,240,167,.6), rgba(123,255,247,.8), rgba(179,102,255,.7));
      box-shadow: 0 0 12px rgba(39,240,167,.35);
      transition: width .35s ease;
    }

    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
      .bottom-row{ grid-column: 1; }
    }

    /* Pop-up missions */
    .missions-wrap { margin-top: 8px; }
    .missions-list { display: grid; gap: 12px; }
    .mission-card{
      background: linear-gradient(180deg, rgba(18,20,48,.9), rgba(12,16,36,.8));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 14px;
      display: grid;
      gap: 8px;
      box-shadow: 0 8px 18px rgba(0,0,0,.45);
    }
    .mission-title{
      font-family: 'Orbitron', sans-serif;
      font-weight: 800;
      letter-spacing: .3px;
      font-size: 18px;
    }
    .mission-meta{
      color: var(--muted);
      font-size: 13px;
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }
    .mission-amount{
      font-weight: 800;
      color: #caffec;
      border:1px solid rgba(39,240,167,.35);
      background: linear-gradient(180deg, rgba(39,240,167,.15), rgba(39,240,167,.06));
      padding: 4px 8px; border-radius: 10px;
    }
    .mission-expectations{ font-size: 14px; line-height: 1.35; }
    .mission-actions{ display:flex; gap:10px; }
    .mission-btn{
      border-radius: 10px; border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      padding:10px 12px; font-weight: 800; letter-spacing:.4px; text-transform: uppercase;
      cursor: pointer;
    }
    .mission-btn.accept{
      border-color: rgba(39,240,167,.45);
      background: linear-gradient(180deg, rgba(39,240,167,.18), rgba(39,240,167,.08));
      color:#caffec; text-shadow: 0 0 8px rgba(39,240,167,.45);
    }
    .mission-badge{
      font-weight:800; font-size: 12px; letter-spacing:.3px; color:#cfe2ff;
      border:1px solid rgba(255,255,255,.18); padding:4px 8px; border-radius:999px;
    }
    /* ===== Modal prompt styles ===== */
.cosmos-modal.hidden { display: none; }
.cosmos-modal {
  position: fixed; inset: 0; z-index: 9999;
  display: grid; place-items: center;
  background: rgba(0,0,0,.45);
  -webkit-backdrop-filter: blur(2px);
  backdrop-filter: blur(2px);
}
.cosmos-modal-card{
  width: min(420px, 92vw);
  background: linear-gradient(180deg, rgba(18,20,48,.98), rgba(12,16,36,.95));
  border: 1px solid rgba(255,255,255,.16);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 18px 42px rgba(0,0,0,.55);
}
.cosmos-modal-card h3{
  margin: 0 0 10px 0; font-family: 'Orbitron', sans-serif;
  font-weight: 800; letter-spacing: .3px; color: #e8f0ff;
}
.cosmos-field{ display: grid; gap: 6px; margin: 8px 0 14px; }
.cosmos-field span{ color: #9aa7c7; font-weight: 700; font-size: 13px; }
#cosmos-modal-input{
  height: 42px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  color: #e8f0ff; font-size: 16px; padding: 8px 10px;
  outline: none;
}
#cosmos-modal-input:focus{
  border-color: rgba(123,255,247,.55);
  box-shadow: 0 0 0 3px rgba(123,255,247,.18);
}
.cosmos-actions{ display:flex; gap:10px; justify-content:flex-end; }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Todayâ€™s Mission Log</div>
        <div class="subtitle" id="sub"></div>
      </div>
      <div id="all-status" class="subtitle"></div>
    </header>

    <section class="grid" id="cards"></section>

    <footer>
      <div class="foot-top">
        <div>Kids tap <span class="kbd">Ready for Inspection</span>. Adults tap <span class="kbd">Confirm & Log</span> (code-locked). Only adult confirmations count toward progress.</div>
        <div>
          <button id="resetBtn" class="kbd" title="Clears todayâ€™s statuses">Reset Today</button>
        </div>
      </div>

      <!-- Weekly Progress -->
      <div class="weekly-wrap">
        <div class="weekly-label">
          <span>Weekly Completion</span>
          <span id="weekly-count">0 / 0</span>
        </div>
        <div class="progress-outer">
          <div class="progress-inner" id="weekly-bar"></div>
        </div>
        <div class="subtitle" style="opacity:.8;">Goal: 100% by Friday</div>
      </div>

      <!-- Pop-up Missions -->
      <div id="missions" class="missions-wrap">
        <div class="missions-header subtitle" style="margin-top:6px;">Pop-Up Missions</div>
        <div id="missions-list" class="missions-list"></div>
      </div>
    </footer>
  </div>

<script>
/***** CONFIG *****/
const SLACK_WEBHOOK_PROXY_URL = "https://hooks.zapier.com/hooks/catch/24636014/um8kba2/";
// === MISSIONS CONFIG ===
const MISSIONS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQaEgUXEMo-_9EBzFaY96OxzV5hSRtsTPpEByEiyIK5Ie3TNYwh_ENfFnrLqrWJv85JKEQyDQQ9ddwh/pub?output=csv";
const MISSIONS_ACCEPT_WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/24636014/um0dnqd/";
const WEEKLY_100_WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/24636014/u1oba61/"; // replace if needed

/* === ADULT CODES (per-adult by default) === */
const USE_SHARED_ADULT_CODE = false;
const SHARED_CODE_KEY = "cosmos_shared_adult_code_v1";
const ADULT_CODES_KEY = "cosmos_adult_codes_v1";
const miniHash = (s) => [...new TextEncoder().encode(s)].reduce((a,b)=>((a<<5)-a)+b,0)>>>0;
const getAdultCodes = () => JSON.parse(localStorage.getItem(ADULT_CODES_KEY) || "{}");
const saveAdultCodes = (m) => localStorage.setItem(ADULT_CODES_KEY, JSON.stringify(m));

  // Promise-based in-page text prompt that reliably opens iPad keyboard
function textPrompt({ title, label, placeholder = "", type = "text" }){
  return new Promise(resolve => {
    const modal = document.getElementById('cosmos-modal');
    const titleEl = document.getElementById('cosmos-modal-title');
    const labelEl = document.getElementById('cosmos-modal-label');
    const input = document.getElementById('cosmos-modal-input');
    const okBtn = document.getElementById('cosmos-ok');
    const cancelBtn = document.getElementById('cosmos-cancel');

    // Configure
    titleEl.textContent = title || "Input";
    labelEl.textContent = label || "Value";
    input.type = (type === "password") ? "password" : "text";
    input.setAttribute("inputmode", type === "number" ? "numeric" : "text");
    input.value = "";
    input.placeholder = placeholder || "";

    // Show
    modal.classList.remove('hidden');

    // iOS focus trick: ensure element is in DOM & visible, then focus after a tick
    requestAnimationFrame(() => {
      setTimeout(() => { input.focus(); }, 0);
    });

    const cleanup = () => {
      modal.classList.add('hidden');
      okBtn.removeEventListener('click', onOk);
      cancelBtn.removeEventListener('click', onCancel);
      input.removeEventListener('keydown', onKey);
    };

    const onOk = () => { const v = input.value.trim(); cleanup(); resolve(v || null); };
    const onCancel = () => { cleanup(); resolve(null); };
    const onKey = (e) => {
      if (e.key === "Enter") onOk();
      if (e.key === "Escape") onCancel();
    };

    okBtn.addEventListener('click', onOk);
    cancelBtn.addEventListener('click', onCancel);
    input.addEventListener('keydown', onKey);
  });
}

  
async function verifyAdultCodeFlow() {
  if (USE_SHARED_ADULT_CODE) {
    let shared = localStorage.getItem(SHARED_CODE_KEY);
    if (!shared) {
      const first = await textPrompt({
        title: "Set Shared Adult Code",
        label: "New code",
        placeholder: "Create a shared code",
        type: "password"
      });
      if (!first) return { ok:false };
      localStorage.setItem(SHARED_CODE_KEY, miniHash(first).toString());
      alert("Shared adult code set.");
    }

    const adultName = await textPrompt({
      title: "Commander ID",
      label: "Your name",
      placeholder: "Enter name here",
      type: "text"
    });
    if (!adultName) return { ok:false };

    const attempt = await textPrompt({
      title: "Enter Shared Code",
      label: `Code for ${adultName}`,
      placeholder: "Enter code",
      type: "password"
    });
    if (!attempt) return { ok:false };

    const valid = localStorage.getItem(SHARED_CODE_KEY);
    if (miniHash(attempt).toString() !== valid) { alert("Incorrect code."); return { ok:false }; }
    return { ok:true, adultName };
  }

  // Per-adult code mode
  const adultName = await textPrompt({
    title: "Commander ID",
    label: "Your name",
    placeholder: "Enter name here",
    type: "text"
  });
  if (!adultName) return { ok:false };

  const codes = getAdultCodes();
  if (!codes[adultName]) {
    const c1 = await textPrompt({
      title: `Create Code for ${adultName}`,
      label: "New code",
      placeholder: "Create a code",
      type: "password"
    });
    if (!c1) return { ok:false };

    const c2 = await textPrompt({
      title: "Confirm Code",
      label: "Re-enter code",
      placeholder: "Confirm your code",
      type: "password"
    });
    if (!c2) return { ok:false };

    if (c1 !== c2) { alert("Codes didn't match."); return { ok:false }; }
    codes[adultName] = miniHash(c1).toString();
    saveAdultCodes(codes);
    alert(`${adultName}'s code set.`);
    return { ok:true, adultName };
  } else {
    const attempt = await textPrompt({
      title: `Enter ${adultName}'s Code`,
      label: "Code",
      placeholder: "Enter your code",
      type: "password"
    });
    if (!attempt) return { ok:false };
    if (miniHash(attempt).toString() !== codes[adultName]) { alert("Incorrect code."); return { ok:false }; }
    return { ok:true, adultName };
  }
}


/* === DATA === */
const KIDS = [
  { id: "avery",   name: "Avery" },
  { id: "adeline", name: "Adeline" },
  { id: "hagen",   name: "Hagen" },
  { id: "astoria", name: "Astoria" },
  { id: "lincoln", name: "Lincoln" }
];

const CHORES_BY_DAY = {
  Monday: [
    { kidId: "avery",   chore: "Downstairs Bathroom" },
    { kidId: "adeline", chore: "Sweep and Swiffer" },
    { kidId: "hagen",   chore: "Sunroom" },
    { kidId: "astoria", chore: "Upstairs Bathroom" },
    { kidId: "lincoln", chore: "Take Out Trash" }
  ],
  Tuesday: [
    { kidId: "avery",   chore: "Take Out Trash" },
    { kidId: "adeline", chore: "Downstairs Bathroom" },
    { kidId: "hagen",   chore: "Sweep and Swiffer" },
    { kidId: "astoria", chore: "Sunroom" },
    { kidId: "lincoln", chore: "Upstairs Bathroom" }
  ],
  Wednesday: [
    { kidId: "avery",   chore: "Upstairs Bathroom" },
    { kidId: "adeline", chore: "Take Out Trash" },
    { kidId: "hagen",   chore: "Downstairs Bathroom" },
    { kidId: "astoria", chore: "Sweep and Swiffer" },
    { kidId: "lincoln", chore: "Sunroom" }
  ],
  Thursday: [
    { kidId: "avery",   chore: "Sunroom" },
    { kidId: "adeline", chore: "Upstairs Bathroom" },
    { kidId: "hagen",   chore: "Take Out Trash" },
    { kidId: "astoria", chore: "Downstairs Bathroom" },
    { kidId: "lincoln", chore: "Sweep and Swiffer" }
  ],
  Friday: [
    { kidId: "avery",   chore: "Sweep and Swiffer" },
    { kidId: "adeline", chore: "Sunroom" },
    { kidId: "hagen",   chore: "Upstairs Bathroom" },
    { kidId: "astoria", chore: "Take Out Trash" },
    { kidId: "lincoln", chore: "Downstairs Bathroom" }
  ]
};

const fmt = new Intl.DateTimeFormat(undefined, { weekday: 'long', month: 'long', day: 'numeric' });

function localDateKey(d = new Date()){
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

/* === DAY CLOCK === */
let now = new Date();
let weekdayName = new Intl.DateTimeFormat(undefined, { weekday: 'long' }).format(now);
let dateKey = localDateKey(now);
let STORAGE_KEY = `choreStatus:${dateKey}`;

function recomputeDay(){
  now = new Date();
  const newWeekday = new Intl.DateTimeFormat(undefined, { weekday: 'long' }).format(now);
  const newDateKey = localDateKey(now);
  const changed = (newDateKey !== dateKey);

  weekdayName = newWeekday;
  dateKey = newDateKey;
  STORAGE_KEY = `choreStatus:${dateKey}`;
  return changed;
}

const $sub = document.getElementById('sub');
const $cards = document.getElementById('cards');
const $allStatus = document.getElementById('all-status');
const $resetBtn = document.getElementById('resetBtn');
const $weeklyBar = document.getElementById('weekly-bar');
const $weeklyCount = document.getElementById('weekly-count');

$sub.textContent = `${fmt.format(now)} â€¢ ${weekdayName}`;

/* === STATE LOAD/SAVE ===
   status[kidId] = "pending" | "completed" | undefined
*/
function loadStatusForDateKey(key){
  try { return JSON.parse(localStorage.getItem(key) || '{}'); }
  catch { return {}; }
}
function loadStatus(){ return loadStatusForDateKey(STORAGE_KEY); }
function saveStatus(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

let status = loadStatus();

function getTodayAssignments(){
  const items = CHORES_BY_DAY[weekdayName] || [];
  const byId = Object.fromEntries(KIDS.map(k => [k.id, k]));
  return items.filter(i => byId[i.kidId]).map(i => ({ ...i, kid: byId[i.kidId] }));
}

/* === WEEK HELPERS === */
const DOW = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
function startOfWeek(d){ // Monday as week start
  const n = new Date(d);
  const day = n.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  n.setDate(n.getDate() + diff);
  n.setHours(0,0,0,0);
  return n;
}
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function getWeekDateKeys(){
  const mon = startOfWeek(now);
  return Array.from({length:5}, (_, i) => localDateKey(addDays(mon, i)));
}
function choresForDayName(name){
  return CHORES_BY_DAY[name] || [];
}

function computeWeeklyTotals(){
  const keys = getWeekDateKeys();
  let completed = 0;
  let totalPossible = 0;

  keys.forEach(k => {
    const [y, m, d] = k.split('-').map(Number);
    const dayName = DOW[new Date(y, m - 1, d).getDay()];
    const assignments = choresForDayName(dayName);
    totalPossible += assignments.length;

    const st = loadStatusForDateKey(`choreStatus:${k}`);
    for (const kidId of Object.keys(st)) {
      if (st[kidId] === "completed") completed++;
    }
  });

  return { completed, totalPossible };
}

function renderWeeklyProgress(){
  const { completed, totalPossible } = computeWeeklyTotals();
  const pct = totalPossible ? Math.round((completed / totalPossible) * 100) : 0;
  $weeklyBar.style.width = `${pct}%`;
  $weeklyCount.textContent = `${completed} / ${totalPossible} (${pct}%)`;
  maybeNotifyWeekly100(pct, completed, totalPossible); 
}
function refreshForNewDay(){
  const crossed = recomputeDay();
  if (crossed) {
    status = loadStatus();
    $sub.textContent = `${fmt.format(now)} â€¢ ${weekdayName}`;
    render();
    renderWeeklyProgress();
    if (typeof fetchMissions === 'function') fetchMissions();
  }
}
setInterval(refreshForNewDay, 60 * 1000);
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') refreshForNewDay();
});
window.addEventListener('focus', refreshForNewDay);

/* === HELPERS FOR RENDER === */
function currentStatus(kidId){ return status[kidId]; }
function setStatus(kidId, val){ status[kidId] = val; saveStatus(status); }

/* === RENDER === */
function render(){
  const items = getTodayAssignments();
  $cards.innerHTML = '';
  let completedCount = 0;
  const bottomCards = [];

  items.forEach((it, index) => {
    const st = currentStatus(it.kidId); // "pending" | "completed" | undefined
    const isPending = (st === "pending");
    const isDone = (st === "completed");
    if(isDone) completedCount++;

    const card = document.createElement('div');
    card.className = 'card ' + (isDone ? 'done-glow' : isPending ? 'pending-glow' : 'todo-glow');

    // header
    const kid = document.createElement('div');
    kid.className = 'kid';
    const av = document.createElement('div');
    av.className = 'avatar';
    av.textContent = it.kid.name[0].toUpperCase();
    const name = document.createElement('h3');
    name.textContent = it.kid.name;
    const pill = document.createElement('div');
    pill.className = 'status ' + (isDone ? 'good' : isPending ? 'warn' : 'bad');
    const dot = document.createElement('span'); dot.className = 'dot';
    dot.style.background = isDone ? 'var(--good)' : isPending ? 'var(--warn)' : 'var(--bad)';
    const pillTxt = document.createElement('span'); pillTxt.textContent = isDone ? 'DONE' : isPending ? 'PENDING' : 'TO DO';
    pill.append(dot, pillTxt);
    kid.append(av, name, pill);

    // chore title
    const chore = document.createElement('div');
    chore.className = 'chore';
    chore.textContent = it.chore;

    // buttons (per card)
    const btns = document.createElement('div');
    btns.className = 'btns';

    const btnRequest = document.createElement('button');
    btnRequest.className = 'big btn-request';
    btnRequest.textContent = 'ðŸš€ Ready for Inspection';
    if (isPending || isDone) btnRequest.classList.add('btn-disabled');

    btnRequest.addEventListener('click', async (ev) => {
  ev.stopPropagation();
  if (btnRequest.classList.contains('btn-disabled')) return;

  // disable immediately to prevent double taps
  btnRequest.classList.add('btn-disabled');
  setStatus(it.kidId, "pending");
  render();

  try {
    await notifyInspectionRequested(it.kid.name, it.chore);
  } catch (e) {
    console.warn('Slack send failed', e);
  }
});

   const btnConfirm = document.createElement('button');
btnConfirm.className = 'big btn-confirm';
btnConfirm.textContent = 'ðŸ›°ï¸ Confirm & Log';
if (isDone) btnConfirm.classList.add('just-done');

btnConfirm.addEventListener('click', async () => {
  const result = await verifyAdultCodeFlow();
  if (!result.ok) return;

  // Optional guard: require pending first
  if (currentStatus(it.kidId) !== "pending") {
    const proceed = confirm("No inspection request logged. Confirm anyway?");
    if (!proceed) return;
  }

  setStatus(it.kidId, "completed");
  render();
  renderWeeklyProgress();
  document.getElementById('completeSound').play();

  // Slack post removed to prevent duplicate Zap triggers
});

    btns.append(btnRequest, btnConfirm);
    card.append(kid, chore, btns);

    if(index < 3){
      $cards.append(card);
    } else {
      bottomCards.push(card);
    }
  });

  if(bottomCards.length){
    const row = document.createElement('div');
    row.className = 'bottom-row';
    bottomCards.forEach(c => row.appendChild(c));
    $cards.append(row);
  }

  const total = items.length;
  $allStatus.textContent = total ? `${completedCount}/${total} confirmed` : 'No missions scheduled for today';
}

/* === TOAST + SLACK === */
function showToast(msg){
  let t = document.getElementById('toast');
  if(!t){
    t = document.createElement('div');
    t.id = 'toast';
    t.style.position = 'fixed';
    t.style.right = '16px';
    t.style.bottom = '16px';
    t.style.zIndex = 9999;
    t.style.padding = '10px 14px';
    t.style.borderRadius = '10px';
    t.style.border = '1px solid rgba(255,255,255,.18)';
    t.style.background = 'linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05))';
    t.style.backdropFilter = 'blur(4px)';
    t.style.color = '#cfe2ff';
    t.style.fontWeight = '800';
    t.style.letterSpacing = '.3px';
    t.style.boxShadow = '0 8px 18px rgba(0,0,0,.45)';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=>{ t.style.opacity = '0'; }, 1800);
}

function slackPost(url, payload, desc="form-urlencoded"){
  const u = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
  const init = {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
    body: new URLSearchParams(payload),
    keepalive: true
  };
  return fetch(u, init).then(r => {
    console.log(`[slack] ${desc} dispatched`, { ok: r.ok, status: r.status });
    showToast('Transmitted to Slack.');
  }).catch(e => console.warn('[slack] send failed', e));
}

async function notifyInspectionRequested(kidName, chore){
  if(!SLACK_WEBHOOK_PROXY_URL) return;
  const payload = {
    type: "inspection_requested",
    kid: kidName,
    chore,
    date: dateKey,
    weekday: weekdayName,
    ts: new Date().toISOString()
  };
  await slackPost(SLACK_WEBHOOK_PROXY_URL, payload, "inspection_requested");
}

/* === CSV / MISSIONS (unchanged) === */
function parseCSV(text){
  const rows = [];
  let i = 0, cur = [], field = '', inQuotes = false;

  while (i < text.length){
    const ch = text[i];

    if (inQuotes){
      if (ch === '"'){
        if (text[i+1] === '"'){ field += '"'; i += 2; continue; } // escaped "
        inQuotes = false; i++; continue;
      }
      field += ch; i++; continue;
    }

    if (ch === '"'){ inQuotes = true; i++; continue; }
    if (ch === ','){ cur.push(field); field = ''; i++; continue; }
    if (ch === '\r'){ i++; continue; }
    if (ch === '\n'){ cur.push(field); rows.push(cur); cur = []; field = ''; i++; continue; }

    field += ch; i++;
  }
  if (field.length || cur.length){ cur.push(field); rows.push(cur); }

  if (!rows.length) return [];
  const headers = rows[0].map(h => h.trim());
  return rows.slice(1).filter(r => r.length && r.some(x => x && x.trim().length)).map(r => {
    const obj = {};
    headers.forEach((h, idx) => obj[h] = (r[idx] ?? '').trim());
    return obj;
  });
}

const $missionsList = document.getElementById('missions-list');

function renderMissions(list){
  $missionsList.innerHTML = '';
  if (!list.length){
    const empty = document.createElement('div');
    empty.className = 'subtitle';
    empty.style.opacity = '.7';
    empty.textContent = 'No pop-up missions right now.';
    $missionsList.appendChild(empty);
    return;
  }

  list.forEach(m => {
    const card = document.createElement('div');
    card.className = 'mission-card';

    const title = document.createElement('div');
    title.className = 'mission-title';
    title.textContent = m.title || 'Mission';

    const meta = document.createElement('div');
    meta.className = 'mission-meta';
    const who = document.createElement('span');
    who.className = 'mission-badge';
    who.textContent = m.createdBy ? `From: ${m.createdBy}` : 'From: Adult';
    const amt = document.createElement('span');
    amt.className = 'mission-amount';
    const n = Number(m.amount);
    amt.textContent = Number.isFinite(n) ? `$${n.toFixed(2)}` : `$${(m.amount||'0')}`;
    meta.append(who, amt);

    const exp = document.createElement('div');
    exp.className = 'mission-expectations';
    exp.textContent = m.expectations || '';

    const actions = document.createElement('div');
    actions.className = 'mission-actions';

    const btn = document.createElement('button');
    btn.className = 'mission-btn accept';
    btn.textContent = 'Accept Mission';

    btn.addEventListener('click', async () => {
      const kid = (prompt('Enter your name to accept:') || '').trim();
      if (!kid) return;

      const payload = new URLSearchParams({
        id: m.id || '',
        title: m.title || '',
        expectations: m.expectations || '',
        amount: m.amount || '',
        createdBy: m.createdBy || '',
        kid,
        date: new Date().toISOString()
      });

      try{
        await fetch(MISSIONS_ACCEPT_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: payload,
          cache: 'no-store',
          keepalive: true
        });
      }catch(e){
        console.warn('Accept webhook failed', e);
      }

      card.remove();
      if(!$missionsList.children.length){
        const empty = document.createElement('div');
        empty.className = 'subtitle';
        empty.style.opacity = '.7';
        empty.textContent = 'No pop-up missions right now.';
        $missionsList.appendChild(empty);
      }
    });

    actions.appendChild(btn);
    card.append(title, meta, exp, actions);
    $missionsList.appendChild(card);
  });
}

async function fetchMissions(){
  if (!MISSIONS_CSV_URL){ renderMissions([]); return; }
  const url = MISSIONS_CSV_URL + (MISSIONS_CSV_URL.includes('?') ? '&' : '?') + 't=' + Date.now();

  try{
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('CSV fetch failed: ' + res.status);
    const text = await res.text();

    let rows = parseCSV(text);

    const norm = rows.map(r => ({
      id:           r.id || r.ID || r.Timestamp || r.timestamp || r.createdAt || '',
      title:        r.title || r['Mission Title'] || r['Title'] || '',
      expectations: r.expectations || r['Expectations / Details'] || r['Expectations'] || '',
      amount:       r.amount || r['Amount'] || r['Amount ($)'] || r['Reward'] || '',
      createdBy:    r.createdBy || r['Adult Name'] || r['From'] || '',
      createdAt:    r.createdAt || r.Timestamp || r.timestamp || ''
    }));

    const items = norm.filter(x => (x.id && x.title));

    renderMissions(items);
  }catch(e){
    console.warn('Failed to load missions', e);
    renderMissions([]);
  }
}

/* prune history but keep this week */
(function pruneOldButKeepThisWeek(){
  const keep = new Set(getWeekDateKeys().map(k => `choreStatus:${k}`));
  const nowT = Date.now();
  for(const k of Object.keys(localStorage)){
    if(!k.startsWith('choreStatus:')) continue;
    if(keep.has(k)) continue;
    const dateStr = k.split(':')[1];
    const t = Date.parse(dateStr);
    if (!Number.isNaN(t) && (nowT - t) > 14*24*60*60*1000){
      localStorage.removeItem(k);
    }
  }
})();

document.getElementById('resetBtn').addEventListener('click', () => {
  status = {}; saveStatus(status); render(); renderWeeklyProgress();
});
// Prevent stale event listeners from piling up
$cards.replaceChildren(); 

/* initial render */
render();
renderWeeklyProgress();
fetchMissions();
setInterval(fetchMissions, 30000); // refresh every 30s
</script>

<!-- PWA: service worker registration -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .catch(err => console.warn('Service worker failed:', err));
    });
  }
</script>
  <audio id="completeSound" src="./sounds/ding.mp3" preload="auto"></audio>
  <!-- Inline modal prompt (replaces window.prompt) -->
<div id="cosmos-modal" class="cosmos-modal hidden" role="dialog" aria-modal="true" aria-labelledby="cosmos-modal-title">
  <div class="cosmos-modal-card">
    <h3 id="cosmos-modal-title">Input</h3>
    <label class="cosmos-field">
      <span id="cosmos-modal-label">Value</span>
      <input id="cosmos-modal-input"
             type="text"
             inputmode="text"
             autocomplete="off"
             autocapitalize="none"
             autocorrect="off"
             spellcheck="false" />
    </label>
    <div class="cosmos-actions">
      <button id="cosmos-cancel" type="button" class="kbd">Cancel</button>
      <button id="cosmos-ok" type="button" class="kbd">OK</button>
    </div>
  </div>
</div>

</body>
</html>
