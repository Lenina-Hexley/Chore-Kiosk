<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
   <title>Chore Chart Â· COSMOS</title>

  <!-- PWA bits -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1026">

  <!-- iOS-specific â€œinstallable web appâ€ flags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Chore Chart">
  <link rel="apple-touch-icon" href="./icons/180.png">

  <style>
    /* COSMOS THEME ... */

    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@500;700;800&display=swap');

    :root{
      --bg1: #070716;          /* deep space */
      --bg2: #0b1026;          /* midnight blue */
      --card: rgba(19, 22, 46, .85);
      --ink: #e8f0ff;
      --muted: #9aa7c7;
      --good: #27f0a7;         /* nebula green */
      --bad: #ff3b7f;          /* magenta flare */
      --edge: rgba(255,255,255,.08);
      --halo: rgba(123, 255, 247, .45); /* cyan halo */
      --halo2: rgba(178, 102, 255, .45); /* purple halo */
      --grid: rgba(120, 172, 255, .06);
    }

    html, body { height: 100%; }
    html { background-color: #070716; } /* solid fallback under the status bar */
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
      user-select: none; overscroll-behavior: none;

      /* layered stars + aurora gradient */
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(123,255,247,.12), transparent 60%),
        radial-gradient(900px 700px at 85% 20%, rgba(178,102,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));

        /* this pushes your content down so it doesn't clash with iOS status bar */
  padding-top: env(safe-area-inset-top);
    }

    /* starfield */
    body::before, body::after{
      content:"";
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:
        radial-gradient(2px 2px at 12% 18%, rgba(255,255,255,.8) 50%, transparent 55%),
        radial-gradient(1.5px 1.5px at 48% 12%, rgba(255,255,255,.7) 50%, transparent 55%),
        radial-gradient(1.2px 1.2px at 78% 28%, rgba(255,255,255,.6) 50%, transparent 55%),
        radial-gradient(2px 2px at 22% 66%, rgba(255,255,255,.85) 50%, transparent 55%),
        radial-gradient(1.4px 1.4px at 66% 72%, rgba(255,255,255,.7) 50%, transparent 55%),
        radial-gradient(1px 1px at 90% 40%, rgba(255,255,255,.6) 50%, transparent 55%);
      opacity:.5;
    }
    body::after{
      filter: blur(0.2px);
      opacity:.35;
      transform: translateZ(0);
    }

    .wrap{ max-width: 1100px; margin: 0 auto; padding: 28px 20px 40px; position: relative; z-index: 1; }
    header{ display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom: 16px; }
    .title{
      font-family: 'Orbitron', sans-serif;
      font-weight:700;
      letter-spacing: 1px;
      font-size: clamp(34px, 4vw, 56px);
      line-height: 1;
      text-transform: uppercase;
      background: linear-gradient(90deg, #b366ff, #7bfff7, #b366ff);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      filter: drop-shadow(0 0 10px rgba(123,255,247,.15));
    }
    .subtitle{
      color: var(--muted);
      font-size: clamp(13px, 2vw, 15px);
      font-weight: 700;
      letter-spacing:.3px;
      margin-top: 6px;
    }

    /* thin holo rule under header */
    header::after{
      content:"";
      display:block;
      position: absolute;
      left:50%;
      transform: translateX(-50%);
      width: min(1000px, 92%);
      height: 2px;
      background:
        linear-gradient(90deg, transparent, rgba(123,255,247,.5) 15%, rgba(179,102,255,.5) 85%, transparent);
      margin-top: 64px;
      box-shadow: 0 0 18px rgba(123,255,247,.25);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      justify-items: center;
      margin-top: 22px;
    }

    .bottom-row {
      grid-column: 1 / span 3;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      justify-content: center;
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(18,20,48,.9), rgba(12,16,36,.8));
      border: 1px solid var(--edge);
      border-radius: 16px;
      padding:18px;
      position:relative; isolation:isolate;
      width: 100%;
      max-width: 300px;
      min-height: 156px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.04) inset,
        0 10px 24px rgba(0,0,0,.45);
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      overflow: clip;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: 16px;
      padding:1px;
      background: linear-gradient(135deg, var(--halo), var(--halo2));
      -webkit-mask: 
        linear-gradient(#000 0 0) content-box, 
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      opacity:.55;
      pointer-events:none;
    }
    .card:hover{ transform: translateY(-2px); }

    .card.todo-glow{
      box-shadow:
        0 0 22px rgba(255,59,127,.25),
        0 10px 24px rgba(0,0,0,.5);
      border-color: rgba(255,59,127,.35);
    }
    .card.done-glow{
      box-shadow:
        0 0 22px rgba(39,240,167,.25),
        0 10px 24px rgba(0,0,0,.5);
      border-color: rgba(39,240,167,.35);
    }

    .kid{ display:flex; align-items:center; gap:10px; margin-bottom:12px; }

    .avatar{
      width:42px; height:42px; border-radius:50%;
      display:grid; place-items:center;
      font-weight:800; color:#0c1024;
      background:
        radial-gradient(circle at 30% 30%, #7bfff7, #b366ff 65%, #4a1a8f 90%);
      border: 2px solid rgba(255,255,255,.55);
      box-shadow:
        inset 0 2px 10px rgba(0,0,0,.35),
        0 0 12px rgba(123,255,247,.35);
      position: relative;
      font-family: 'Orbitron', sans-serif;
    }
    .avatar::after{
      content:"";
      position:absolute; inset:-6px;
      border-radius: 50%;
      border: 1px solid rgba(123,255,247,.35);
      transform: rotate(20deg);
      filter: blur(.3px);
      pointer-events:none;
    }

    .kid h3{
      margin:0;
      font-size:18px;
      letter-spacing:.3px;
      font-weight:800;
      font-family: 'Inter', sans-serif;
    }

    .status{
      margin-left:auto;
      font-weight:800; font-size: 12px; letter-spacing:.4px;
      padding:6px 10px; border-radius: 999px;
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      backdrop-filter: blur(3px);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
      text-transform: uppercase;
    }
    .dot{ width:10px; height:10px; border-radius:50%; }
    .status.good{ color: var(--good); }
    .status.bad{ color: var(--bad); }

    .chore{
      margin-top: 6px;
      font-size: clamp(20px, 2.3vw, 24px);
      color: var(--ink);
      font-weight:800;
      text-align:center;
      letter-spacing:.3px;
      font-family: 'Orbitron', sans-serif;
      text-transform: uppercase;
    }

    .btns{ display:flex; gap:12px; margin-top:auto; }

    button.big{
      position: relative;
      flex:1; padding:14px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      color: var(--ink);
      font-size:15px; font-weight:800; letter-spacing:.4px;
      text-transform: uppercase;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        0 6px 14px rgba(0,0,0,.45);
      transition: transform .1s ease, background .15s ease, box-shadow .15s ease, border-color .15s ease;
      backdrop-filter: blur(3px);
    }
    button.big:active{ transform: translateY(1px); }

    .done{
      border-color: rgba(39,240,167,.45);
      background: linear-gradient(180deg, rgba(39,240,167,.18), rgba(39,240,167,.08));
      color:#caffec;
      text-shadow: 0 0 8px rgba(39,240,167,.45);
    }
    .todo{
      border-color: rgba(255,59,127,.45);
      background: linear-gradient(180deg, rgba(255,59,127,.18), rgba(255,59,127,.08));
      color:#ffd3e3;
      text-shadow: 0 0 8px rgba(255,59,127,.45);
    }
    .just-done{ animation: bounce .4s ease; }

    @keyframes bounce {
      0%   { transform: scale(1); }
      30%  { transform: scale(1.06); }
      50%  { transform: scale(0.97); }
      70%  { transform: scale(1.03); }
      100% { transform: scale(1); }
    }

    footer{
      margin-top: 18px;
      display:flex; flex-direction:column; gap:10px;
      color: var(--muted); font-size: 13px; font-weight:700;
      border-top: 1px solid rgba(255,255,255,.1);
      padding-top: 14px;
    }

    .foot-top{
      display:flex; justify-content:space-between; align-items:center;
      gap: 12px;
    }

    .kbd{
      font-family: 'Inter', monospace;
      background: rgba(255,255,255,.06);
      padding:4px 8px; border-radius:8px;
      border:1px solid rgba(255,255,255,.18);
      color:#cfe2ff; font-weight:800;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing:.5px;
    }

    /* === Weekly Progress Bar (NEW) === */
    .weekly-wrap{
      display:flex; flex-direction:column; gap:8px;
    }
    .weekly-label{
      display:flex; justify-content:space-between; align-items:center;
      font-weight:800; color:#cfe2ff;
    }
    .progress-outer{
      width:100%; height:14px; border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.2), 0 0 0 1px rgba(255,255,255,.04);
      overflow:hidden;
    }
    .progress-inner{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(39,240,167,.6), rgba(123,255,247,.8), rgba(179,102,255,.7));
      box-shadow: 0 0 12px rgba(39,240,167,.35);
      transition: width .35s ease;
    }

    /* Responsive */
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
      .bottom-row{ grid-column: 1; }
    }
    /* Pop-up missions */
.missions-wrap { margin-top: 8px; }
.missions-list { display: grid; gap: 12px; }
.mission-card{
  background: linear-gradient(180deg, rgba(18,20,48,.9), rgba(12,16,36,.8));
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 14px;
  padding: 14px;
  display: grid;
  gap: 8px;
  box-shadow: 0 8px 18px rgba(0,0,0,.45);
}
.mission-title{
  font-family: 'Orbitron', sans-serif;
  font-weight: 800;
  letter-spacing: .3px;
  font-size: 18px;
}
.mission-meta{
  color: var(--muted);
  font-size: 13px;
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
}
.mission-amount{
  font-weight: 800;
  color: #caffec;
  border:1px solid rgba(39,240,167,.35);
  background: linear-gradient(180deg, rgba(39,240,167,.15), rgba(39,240,167,.06));
  padding: 4px 8px; border-radius: 10px;
}
.mission-expectations{ font-size: 14px; line-height: 1.35; }
.mission-actions{ display:flex; gap:10px; }
.mission-btn{
  border-radius: 10px; border:1px solid rgba(255,255,255,.18);
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  padding:10px 12px; font-weight: 800; letter-spacing:.4px; text-transform: uppercase;
  cursor: pointer;
}
.mission-btn.accept{
  border-color: rgba(39,240,167,.45);
  background: linear-gradient(180deg, rgba(39,240,167,.18), rgba(39,240,167,.08));
  color:#caffec; text-shadow: 0 0 8px rgba(39,240,167,.45);
}
.mission-badge{
  font-weight:800; font-size: 12px; letter-spacing:.3px; color:#cfe2ff;
  border:1px solid rgba(255,255,255,.18); padding:4px 8px; border-radius:999px;
}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Todayâ€™s Mission Log</div>
        <div class="subtitle" id="sub"></div>
      </div>
      <div id="all-status" class="subtitle"></div>
    </header>

    <section class="grid" id="cards"></section>

    <footer>
      <div class="foot-top">
        <div>Tap to toggle <span class="kbd">MARK AS COMPLETED</span> / <span class="kbd">COMPLETED</span>. Weâ€™ll ping Slack when a task is completed.</div>
        <div>
          <button id="resetBtn" class="kbd" title="Clears todayâ€™s checkmarks">Reset Today</button>
        </div>
      </div>

      <!-- Weekly Progress (NEW) -->
      <div class="weekly-wrap">
        <div class="weekly-label">
          <span>Weekly Completion</span>
          <span id="weekly-count">0 / 0</span>
        </div>
        <div class="progress-outer">
          <div class="progress-inner" id="weekly-bar"></div>
        </div>
        <div class="subtitle" style="opacity:.8;">Goal: 100% by Friday</div>
      </div>
      <!-- Pop-up Missions -->
<div id="missions" class="missions-wrap">
  <div class="missions-header subtitle" style="margin-top:6px;">Pop-Up Missions</div>
  <div id="missions-list" class="missions-list"></div>
</div>
    </footer>
  </div>

<script>
/***** CONFIG *****/
const SLACK_WEBHOOK_PROXY_URL = "https://hooks.zapier.com/hooks/catch/24636014/um8kba2/";
// === MISSIONS CONFIG ===
// 1) Published CSV URL from your Google Sheet (the one ending with ?output=csv)
const MISSIONS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQaEgUXEMo-_9EBzFaY96OxzV5hSRtsTPpEByEiyIK5Ie3TNYwh_ENfFnrLqrWJv85JKEQyDQQ9ddwh/pub?gid=2046413487&single=true&output=csv";
// 2) Zapier Catch Hook URL that will post to Slack & delete the row
const MISSIONS_ACCEPT_WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/24636014/um0dnqd/";


const KIDS = [
  { id: "avery",   name: "Avery" },
  { id: "adeline", name: "Adeline" },
  { id: "hagen",   name: "Hagen" },
  { id: "astoria", name: "Astoria" },
  { id: "lincoln", name: "Lincoln" }
];

const CHORES_BY_DAY = {
  Monday: [
    { kidId: "avery",   chore: "Downstairs Bathroom" },
    { kidId: "adeline", chore: "Sweep and Swiffer" },
    { kidId: "hagen",   chore: "Sunroom" },
    { kidId: "astoria", chore: "Upstairs Bathroom" },
    { kidId: "lincoln", chore: "Take Out Trash" }
  ],
  Tuesday: [
    { kidId: "avery",   chore: "Take Out Trash" },
    { kidId: "adeline", chore: "Downstairs Bathroom" },
    { kidId: "hagen",   chore: "Sweep and Swiffer" },
    { kidId: "astoria", chore: "Sunroom" },
    { kidId: "lincoln", chore: "Upstairs Bathroom" }
  ],
  Wednesday: [
    { kidId: "avery",   chore: "Upstairs Bathroom" },
    { kidId: "adeline", chore: "Take Out Trash" },
    { kidId: "hagen",   chore: "Downstairs Bathroom" },
    { kidId: "astoria", chore: "Sweep and Swiffer" },
    { kidId: "lincoln", chore: "Sunroom" }
  ],
  Thursday: [
    { kidId: "avery",   chore: "Sunroom" },
    { kidId: "adeline", chore: "Upstairs Bathroom" },
    { kidId: "hagen",   chore: "Take Out Trash" },
    { kidId: "astoria", chore: "Downstairs Bathroom" },
    { kidId: "lincoln", chore: "Sweep and Swiffer" }
  ],
  Friday: [
    { kidId: "avery",   chore: "Sweep and Swiffer" },
    { kidId: "adeline", chore: "Sunroom" },
    { kidId: "hagen",   chore: "Upstairs Bathroom" },
    { kidId: "astoria", chore: "Take Out Trash" },
    { kidId: "lincoln", chore: "Downstairs Bathroom" }
  ]
};

const fmt = new Intl.DateTimeFormat(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
const today = new Date();
const weekdayName = new Intl.DateTimeFormat(undefined, { weekday: 'long' }).format(today);

// NEW: local (not UTC) date key so days don't shift overnight
function localDateKey(d = new Date()){
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

const dateKey = localDateKey(today);                   // â† was toISOString().slice(0,10)
const STORAGE_KEY = `choreStatus:${dateKey}`;

const $sub = document.getElementById('sub');
const $cards = document.getElementById('cards');
const $allStatus = document.getElementById('all-status');
const $resetBtn = document.getElementById('resetBtn');
const $weeklyBar = document.getElementById('weekly-bar');     // NEW
const $weeklyCount = document.getElementById('weekly-count');  // NEW

$sub.textContent = `${fmt.format(today)} â€¢ ${weekdayName}`;

function loadStatusForDateKey(key){
  try { return JSON.parse(localStorage.getItem(key) || '{}'); }
  catch { return {}; }
}
function loadStatus(){ return loadStatusForDateKey(STORAGE_KEY); }
function saveStatus(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

let status = loadStatus();
let lastBounce = { id: null, did: false };

function getTodayAssignments(){
  const items = CHORES_BY_DAY[weekdayName] || [];
  const byId = Object.fromEntries(KIDS.map(k => [k.id, k]));
  return items.filter(i => byId[i.kidId]).map(i => ({ ...i, kid: byId[i.kidId] }));
}

/* === Week helpers (NEW) === */
const DOW = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
function startOfWeek(d){ // Monday as week start
  const n = new Date(d);
  const day = n.getDay(); // 0=Sun..6=Sat
  const diff = (day === 0 ? -6 : 1 - day); // back to Monday
  n.setDate(n.getDate() + diff);
  n.setHours(0,0,0,0);
  return n;
}
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }

// Use localDateKey so Monday stays Monday in your timezone
function getWeekDateKeys(){
  const mon = startOfWeek(today);
  // Monâ€“Fri
  return Array.from({length:5}, (_, i) => localDateKey(addDays(mon, i)));
}

function choresForDayName(name){
  return CHORES_BY_DAY[name] || [];
}

function computeWeeklyTotals(){
  const keys = getWeekDateKeys();

  let completed = 0;
  let totalPossible = 0;

  keys.forEach(k => {
    // compute day name from date
    const dayName = DOW[new Date(k).getDay()];
    const assignments = choresForDayName(dayName);
    totalPossible += assignments.length;

    const st = loadStatusForDateKey(`choreStatus:${k}`);
    // count true values
    for (const kidId of Object.keys(st)) {
      if (st[kidId]) completed++;
    }
  });

  return { completed, totalPossible };
}

function renderWeeklyProgress(){
  const { completed, totalPossible } = computeWeeklyTotals();
  const pct = totalPossible ? Math.round((completed / totalPossible) * 100) : 0;
  $weeklyBar.style.width = `${pct}%`;
  $weeklyCount.textContent = `${completed} / ${totalPossible} (${pct}%)`;
}

/* === RENDER === */
function render(){
  const items = getTodayAssignments();
  $cards.innerHTML = '';
  let doneCount = 0;
  const bottomCards = [];

  items.forEach((it, index) => {
    const done = !!status[it.kidId];
    if(done) doneCount++;

    const card = document.createElement('div');
    card.className = 'card ' + (done ? 'done-glow' : 'todo-glow');

    const kid = document.createElement('div');
    kid.className = 'kid';
    const av = document.createElement('div');
    av.className = 'avatar';
    av.textContent = it.kid.name[0].toUpperCase();
    const name = document.createElement('h3');
    name.textContent = it.kid.name;

    const pill = document.createElement('div');
    pill.className = `status ${done ? 'good' : 'bad'}`;
    const dot = document.createElement('span'); dot.className = 'dot'; dot.style.background = done ? 'var(--good)' : 'var(--bad)';
    const pillTxt = document.createElement('span'); pillTxt.textContent = done ? 'DONE' : 'TO DO';
    pill.append(dot, pillTxt);

    kid.append(av, name, pill);

    const chore = document.createElement('div');
    chore.className = 'chore';
    chore.textContent = it.chore;

    const btns = document.createElement('div');
    btns.className = 'btns';

    const btn = document.createElement('button');
    btn.className = `big ${done ? 'done' : 'todo'}`;
    btn.textContent = done ? 'COMPLETED' : 'Mark as COMPLETED';

    if (done && lastBounce.id === it.kidId && lastBounce.did) {
      btn.classList.add('just-done');
    }

    btn.addEventListener('click', async () => {
  const nowDone = !done;
  status[it.kidId] = nowDone;
  saveStatus(status);
  lastBounce = { id: it.kidId, did: nowDone };
  render();                 // re-render cards
  renderWeeklyProgress();   // update weekly bar (NEW)

  if (nowDone) { 
    document.getElementById('completeSound').play();
    await notifySlack(it.kid.name, it.chore); 
  }
});  // ðŸ‘ˆ closes both the function and addEventListener


    btns.append(btn);
    card.append(kid, chore, btns);

    if(index < 3){
      $cards.append(card);
    } else {
      bottomCards.push(card);
    }
  });

  if(bottomCards.length){
    const row = document.createElement('div');
    row.className = 'bottom-row';
    bottomCards.forEach(c => row.appendChild(c));
    $cards.append(row);
  }

  const total = items.length;
  $allStatus.textContent = total ? `${doneCount}/${total} completed` : 'No missions scheduled for today';
  lastBounce = { id: null, did: false };
}

async function notifySlack(kidName, chore){
  if(!SLACK_WEBHOOK_PROXY_URL) return;
  try{
    const payload = new URLSearchParams({
      kid: kidName,
      chore,
      date: dateKey
    });
    const res = await fetch(SLACK_WEBHOOK_PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: payload
    });
    // optional: donâ€™t rely on res.ok since CORS may still hide it
  }catch(err){
    console.warn('Zapier error', err);
  }
}

function parseCSV(text){
  const rows = [];
  let i = 0, cur = [], field = '', inQuotes = false;

  while (i < text.length){
    const ch = text[i];

    if (inQuotes){
      if (ch === '"'){
        if (text[i+1] === '"'){ field += '"'; i += 2; continue; } // escaped "
        inQuotes = false; i++; continue;
      }
      field += ch; i++; continue;
    }

    if (ch === '"'){ inQuotes = true; i++; continue; }
    if (ch === ','){ cur.push(field); field = ''; i++; continue; }
    if (ch === '\r'){ i++; continue; }
    if (ch === '\n'){ cur.push(field); rows.push(cur); cur = []; field = ''; i++; continue; }

    field += ch; i++;
  }
  if (field.length || cur.length){ cur.push(field); rows.push(cur); }

  if (!rows.length) return [];
  const headers = rows[0].map(h => h.trim());
  return rows.slice(1).filter(r => r.length && r.some(x => x && x.trim().length)).map(r => {
    const obj = {};
    headers.forEach((h, idx) => obj[h] = (r[idx] ?? '').trim());
    return obj;
  });
}

// --- Missions UI ---
const $missionsList = document.getElementById('missions-list');

function renderMissions(list){
  $missionsList.innerHTML = '';
  if (!list.length){
    const empty = document.createElement('div');
    empty.className = 'subtitle';
    empty.style.opacity = '.7';
    empty.textContent = 'No pop-up missions right now.';
    $missionsList.appendChild(empty);
    return;
  }

  list.forEach(m => {
    const card = document.createElement('div');
    card.className = 'mission-card';

    const title = document.createElement('div');
    title.className = 'mission-title';
    title.textContent = m.title || 'Mission';

    const meta = document.createElement('div');
    meta.className = 'mission-meta';
    const who = document.createElement('span');
    who.className = 'mission-badge';
    who.textContent = m.createdBy ? `From: ${m.createdBy}` : 'From: Adult';
    const amt = document.createElement('span');
    amt.className = 'mission-amount';
    const n = Number(m.amount);
    amt.textContent = Number.isFinite(n) ? `$${n.toFixed(2)}` : `$${(m.amount||'0')}`;
    meta.append(who, amt);

    const exp = document.createElement('div');
    exp.className = 'mission-expectations';
    exp.textContent = m.expectations || '';

    const actions = document.createElement('div');
    actions.className = 'mission-actions';

    const btn = document.createElement('button');
    btn.className = 'mission-btn accept';
    btn.textContent = 'Accept Mission';

    btn.addEventListener('click', async () => {
      const kid = (prompt('Enter your name to accept:') || '').trim();
      if (!kid) return;

      const payload = new URLSearchParams({
        id: m.id || '',
        title: m.title || '',
        expectations: m.expectations || '',
        amount: m.amount || '',
        createdBy: m.createdBy || '',
        kid,
        date: new Date().toISOString()
      });

      try{
        console.log('POSTing accept', MISSIONS_ACCEPT_WEBHOOK_URL, Object.fromEntries(payload));
        await fetch(MISSIONS_ACCEPT_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: payload,
          cache: 'no-store',
          keepalive: true
        });
      }catch(e){
        console.warn('Accept webhook failed', e);
      }

      // Optimistic UI removal
      card.remove();
      if(!$missionsList.children.length){
        const empty = document.createElement('div');
        empty.className = 'subtitle';
        empty.style.opacity = '.7';
        empty.textContent = 'No pop-up missions right now.';
        $missionsList.appendChild(empty);
      }
    });

    actions.appendChild(btn);
    card.append(title, meta, exp, actions);
    $missionsList.appendChild(card);
  });
}

// --- Fetch missions from the published CSV ---
async function fetchMissions(){
  if (!MISSIONS_CSV_URL){ renderMissions([]); return; }
  const url = MISSIONS_CSV_URL + (MISSIONS_CSV_URL.includes('?') ? '&' : '?') + 't=' + Date.now();

  try{
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('CSV fetch failed: ' + res.status);
    const text = await res.text();
    console.log('[missions] raw csv length:', text.length);

    let rows = parseCSV(text);
    console.log('[missions] parsed rows:', rows.length, rows[0]);

    // Normalize likely header variants
    const norm = rows.map(r => ({
      id:           r.id || r.ID || r.Timestamp || r.timestamp || r.createdAt || '',
      title:        r.title || r['Mission Title'] || r['Title'] || '',
      expectations: r.expectations || r['Expectations / Details'] || r['Expectations'] || '',
      amount:       r.amount || r['Amount'] || r['Amount ($)'] || r['Reward'] || '',
      createdBy:    r.createdBy || r['Adult Name'] || r['From'] || '',
      createdAt:    r.createdAt || r.Timestamp || r.timestamp || ''
    }));

    // Keep rows that have at least id + title
    const items = norm.filter(x => (x.id && x.title));
    console.log('[missions] normalized items:', items.length);

    renderMissions(items);
  }catch(e){
    console.warn('Failed to load missions', e);
    renderMissions([]);
  }
}

/* keep only recent history, but DO NOT remove this-week keys (NEW) */
(function pruneOldButKeepThisWeek(){
  const keep = new Set(getWeekDateKeys().map(k => `choreStatus:${k}`));
  const now = Date.now();
  for(const k of Object.keys(localStorage)){
    if(!k.startsWith('choreStatus:')) continue;
    if(keep.has(k)) continue;
    // keep ~2 weeks of history just in case; else remove
    const dateStr = k.split(':')[1];
    const t = Date.parse(dateStr);
    if (!Number.isNaN(t) && (now - t) > 14*24*60*60*1000){
      localStorage.removeItem(k);
    }
  }
})();

$resetBtn.addEventListener('click', () => { status = {}; saveStatus(status); render(); renderWeeklyProgress(); });

/* initial render */
render();
renderWeeklyProgress();
fetchMissions();
setInterval(fetchMissions, 30000); // refresh every 30s
</script>

<!-- PWA: service worker registration -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .catch(err => console.warn('Service worker failed:', err));
    });
  }
</script>
  <audio id="completeSound" src="./sounds/ding.mp3" preload="auto"></audio>
</body>
</html>
